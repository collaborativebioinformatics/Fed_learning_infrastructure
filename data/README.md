# Federated Genomic Data for GWAS

Simulated genomic datasets for federated learning across 10 distributed healthcare sites.

## Overview

- **10 heterogeneous sites** with varying sample sizes (88K-110K individuals)
- **~500K SNPs** per site across the genome
- **Parkinson's disease phenotype** (binary trait, 1% prevalence, h²=0.25)
- **Realistic LD structure** generated with LDAK
- **Auto-generated covariates** (age, sex, demographic variables)

## Quick Start for Federated Sites

Each site downloads only their assigned data and runs analysis locally.

### 1. Download Your Site Data
```bash
# From project root
./scripts/download_site_from_s3.sh 1    # Site 1
./scripts/download_site_from_s3.sh 2    # Site 2
# etc...
```

**Prerequisites:** AWS CLI configured (`aws configure`)

**Download size:** ~15 GB per site

### 2. Run GWAS Analysis
```bash
# From project root
./scripts/run_regenie_site.sh 1    # Analyze site 1
```

**Prerequisites:** Docker Desktop installed and running

**Runtime:** ~30-45 minutes total
- Step 1 (LOCO model): 15-30 min
- Step 2 (association testing): 10-20 min

### 3. View Results

Association results saved in:
```
data/simulated_sites/site1/
├── regenie_step1_*.loco           # LOCO prediction models
├── regenie_step2_*.regenie        # Association results
└── regenie_step2.log              # Analysis log
```

**View top associations:**
```bash
head -20 data/simulated_sites/site1/regenie_step2_*.regenie
```

## Project Structure
```
Fed_learning_infrastructure/
├── scripts/
│   ├── download_site_from_s3.sh       # Download site data from S3
│   ├── run_regenie_site.sh            # Run REGENIE GWAS analysis
│   └── generate_federated_sites.sh    # Generate synthetic data (admin)
├── tools/
│   └── ldak6.1.mac                    # LDAK binary (gitignored)
├── data/
│   └── simulated_sites/
│       ├── README.md                  # This file
│       ├── site1/                     # Site 1 data (after download)
│       │   ├── site1_geno.bed/bim/fam
│       │   ├── site1_pheno.pheno
│       │   └── site1_geno.covar
│       ├── site2/                     # Site 2 data
│       └── ... (sites 3-10)
└── README.md                          # Main project README
```

## Data Specifications

### Genotypes
- **Format:** PLINK binary (.bed/.bim/.fam)
- **Variants:** ~500K SNPs (450K-520K per site)
- **Samples:** ~100K individuals (88K-110K per site)
- **Chromosomes:** 22 autosomes
- **MAF:** Uniform distribution 0.01-0.5
- **LD:** Generated by LDAK (realistic structure)

### Phenotype
- **File:** `site{N}_pheno.pheno`
- **Format:** Space-delimited (FID IID Pheno)
- **Trait:** Parkinson's disease (binary: 0=control, 1=case)
- **Prevalence:** 1% (realistic for elderly populations)
- **Heritability:** h² = 0.25 on liability scale
- **Causal variants:** 20 per site
- **Effect size model:** LDAK-Thin (power = -0.25)

### Covariates
- **File:** `site{N}_geno.covar`
- **Auto-generated by LDAK**
- **Variables:** Age, sex, and other demographic covariates
- **Variance explained:** ~10% of phenotypic variation

## Detailed Setup Instructions

### Prerequisites

1. **Docker Desktop**
```bash
   # Install from: https://www.docker.com/products/docker-desktop/
   # Ensure Docker is running before analysis
```

2. **AWS CLI**
```bash
   # Install
   brew install awscli
   
   # Configure with your credentials
   aws configure
   # Enter: Access Key, Secret Key, Region (e.g., us-east-1)
```

3. **Verify Setup**
```bash
   # Test Docker
   docker --version
   docker ps
   
   # Test AWS access
   aws s3 ls s3://flsynthdata/sitesdata/
```

### Download Workflow
```bash
# 1. Clone repository (if not already done)
git clone https://github.com/collaborativebioinformatics/Fed_learning_infrastructure.git
cd Fed_learning_infrastructure

# 2. Download your assigned site (e.g., Site 3)
./scripts/download_site_from_s3.sh 3

# 3. Verify download
ls -lh data/simulated_sites/site3/
# Should show ~15 GB total:
# - site3_geno.bed (~12-13 GB)
# - site3_geno.bim (~10-20 MB)
# - site3_geno.fam (~2-3 MB)
# - site3_pheno.pheno (~2 MB)
# - site3_geno.covar (~5-10 MB)
```

### REGENIE Analysis Workflow

**What REGENIE does:**

**Step 1 - LOCO Prediction Model**
- Leave-One-Chromosome-Out ridge regression
- Builds polygenic prediction models
- Controls for genome-wide polygenic effects
- Output: Predictions for each chromosome

**Step 2 - Association Testing**
- Tests each SNP for association with Parkinson's
- Uses Firth regression (better for binary traits)
- Controls for covariates and polygenic background
- Output: Genome-wide association statistics

**Run analysis:**
```bash
# Complete two-step GWAS
./scripts/run_regenie_site.sh 3

# Monitor progress
# Step 1: You'll see "Processing chromosome X..."
# Step 2: You'll see "Testing associations..."
```

### Understanding Results

**Output files:**
```
regenie_step1.loco          # LOCO predictions
regenie_step1.log           # Step 1 log
regenie_step1_pred.list     # Prediction file list
regenie_step2_*.regenie     # Association results
regenie_step2.log           # Step 2 log
```

**Association results format:**
```
CHROM GENPOS ID ALLELE0 ALLELE1 A1FREQ N TEST BETA SE CHISQ LOG10P EXTRA
1     12345  rs123 A G 0.25 100000 ADD 0.05 0.02 6.25 3.2 ...
```

**Key columns:**
- `CHROM`: Chromosome number
- `GENPOS`: Base pair position
- `ID`: SNP identifier (rs number or chr:pos)
- `ALLELE0`: Reference allele
- `ALLELE1`: Alternate allele (tested)
- `A1FREQ`: Alternate allele frequency
- `BETA`: Effect size (log odds ratio for binary traits)
- `SE`: Standard error
- `LOG10P`: -log10(p-value) - higher = more significant

**Find genome-wide significant hits:**
```bash
# Genome-wide significance: p < 5e-8 (LOG10P > 7.3)
awk '$11 > 7.3' data/simulated_sites/site3/regenie_step2_*.regenie

# Top 20 associations
sort -k11 -gr data/simulated_sites/site3/regenie_step2_*.regenie | head -20
```

**Manhattan plot (R):**
```r
library(qqman)
results <- read.table("data/simulated_sites/site3/regenie_step2_*.regenie", header=TRUE)
results$P <- 10^(-results$LOG10P)
manhattan(results, chr="CHROM", bp="GENPOS", p="P", snp="ID")
```

## For Administrators

### Generate New Site Data
```bash
# Generate a single site (e.g., Site 1)
./scripts/generate_federated_sites.sh 1

# Runtime: 2-5 hours per site
# Disk space: ~15 GB per site
```

**Note:** LDAK binary must be in `tools/` directory:
```bash
# Download LDAK
curl -L -o tools/ldak6.1.mac https://github.com/dougspeed/LDAK/raw/main/ldak6.1.mac
chmod +x tools/ldak6.1.mac
```

### Upload Data to S3
```bash
# Upload single site
aws s3 sync data/simulated_sites/site1/ s3://flsynthdata/sitesdata/site1/ \
  --exclude "*" \
  --include "*.bed" \
  --include "*.bim" \
  --include "*.fam" \
  --include "*.pheno" \
  --include "*.covar"

# Upload all sites (run from data/simulated_sites/)
for site in {1..10}; do
  aws s3 sync site${site}/ s3://flsynthdata/sitesdata/site${site}/ \
    --exclude "*" \
    --include "*.bed" \
    --include "*.bim" \
    --include "*.fam" \
    --include "*.pheno" \
    --include "*.covar"
done
```

## Federated Learning Integration

This data structure enables:

1. **Privacy-Preserving GWAS**
   - Raw genotype data never leaves local sites
   - Only summary statistics are shared
   - Complies with data governance requirements

2. **Distributed Analysis**
   - Each site runs REGENIE locally
   - No centralized data repository needed
   - Sites can have different sample sizes

3. **Meta-Analysis**
   - Aggregate LOG10P values across sites
   - Combine BETA estimates with inverse-variance weighting
   - Test for heterogeneity across sites

4. **Federated Learning Frameworks**
   - Compatible with NVIDIA FLARE
   - Can be adapted for other FL frameworks
   - Supports iterative model training

## Troubleshooting

### Download Issues

**AWS credentials error:**
```bash
# Reconfigure AWS CLI
aws configure

# Test access
aws s3 ls s3://flsynthdata/
```

**Slow download:**
```bash
# Check download speed
# Each site is ~15 GB, expect:
# - Fast connection (100 Mbps): ~20 minutes
# - Typical home (25 Mbps): ~1-2 hours
```

### Docker Issues

**Docker not running:**
```bash
# Start Docker Desktop application
# Wait for "Docker Desktop is running" message
```

**Image pull fails:**
```bash
# Manually pull REGENIE image
docker pull ghcr.io/rgcgithub/regenie/regenie:v4.1.gz

# If still fails, check internet connection
```

**Platform warning (Apple Silicon):**
```
WARNING: The requested image's platform (linux/amd64) does not match...
```
This is expected on M1/M2/M3 Macs. REGENIE will work via Rosetta emulation.

### REGENIE Errors

**"Phenotype file not found":**
- Check file paths are correct
- Ensure you're running from project root
- Verify site data was downloaded completely

**Out of memory:**
```bash
# Increase Docker memory allocation
# Docker Desktop → Settings → Resources → Memory
# Increase to 8-16 GB
```

**Step 1 takes very long:**
- Expected: 15-30 minutes for 100K samples
- If >1 hour, check system resources
- Consider using `--lowmem` flag (already included)

### Disk Space

**Requirements:**
- Each site: ~15 GB (raw data)
- REGENIE results: ~1-2 GB per site
- Total: ~17 GB per site

**Check available space:**
```bash
df -h .
```

## Citation

If using this data, please cite:

- **LDAK:** Speed et al. (2020). Improved heritability estimation from genome-wide SNPs. *Nature Genetics*. https://doi.org/10.1038/s41588-019-0530-8

- **REGENIE:** Mbatchou et al. (2021). Computationally efficient whole-genome regression for quantitative and binary traits. *Nature Genetics*. https://doi.org/10.1038/s41588-021-00870-7

- **This project:** [Add citation when published]

## Additional Resources

- **REGENIE documentation:** https://rgcgithub.github.io/regenie/
- **LDAK documentation:** https://dougspeed.com/
- **PLINK file formats:** https://www.cog-genomics.org/plink/1.9/formats
- **Federated learning:** NVIDIA FLARE documentation

## Support

For questions or issues:
- Open an issue on GitHub: https://github.com/collaborativebioinformatics/Fed_learning_infrastructure/issues
- Contact hackathon organizers
- Check script logs in `data/simulated_sites/site{N}/regenie_*.log`

## License

Data and scripts: MIT License (see repository root)